# Fastfile - Obsidian Notes
# App Store Connectè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š

default_platform(:ios)

platform :ios do
  desc "ğŸš€ App Store Connect - Beta (TestFlight) ãƒ‡ãƒ—ãƒ­ã‚¤"
  lane :beta do
    # ç’°å¢ƒå¤‰æ•°ç¢ºèª
    ensure_env_vars(
      env_vars: ['FASTLANE_APPLE_ID', 'DEVELOPER_APP_IDENTIFIER']
    )

    # Xcodeãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ“ãƒ«ãƒ‰
    build_app(
      scheme: "Obsidian Notes",
      export_method: "app-store",
      output_directory: "./build"
    )

    # TestFlightã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    upload_to_testflight(
      beta_app_feedback_email: ENV['FASTLANE_APPLE_ID'],
      beta_app_description: "Obsidian Notes - ç¾ã—ã„ãƒ¡ãƒ¢ã‚¢ãƒ—ãƒªã®æ–°ã—ã„ãƒ“ãƒ«ãƒ‰",
      demo_account_required: false,
      notify_external_testers: false,
      skip_waiting_for_build_processing: true
    )

    # æˆåŠŸé€šçŸ¥
    puts "ğŸ‰ TestFlightã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼"
    puts "ğŸ“± App Store Connectã§ç¢ºèªã—ã¦ãã ã•ã„"
  end

  desc "ğŸŒŸ App Store Connect - Release ãƒ‡ãƒ—ãƒ­ã‚¤"
  lane :release do
    # ç’°å¢ƒå¤‰æ•°ç¢ºèª
    ensure_env_vars(
      env_vars: ['FASTLANE_APPLE_ID', 'DEVELOPER_APP_IDENTIFIER']
    )

    # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    upload_to_app_store(
      submit_for_review: false,
      automatic_release: false,
      force: true,
      metadata_path: "./fastlane/metadata",
      screenshots_path: "./fastlane/screenshots"
    )

    # æˆåŠŸé€šçŸ¥
    puts "ğŸ‰ App Store Connectã«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼"
    puts "ğŸŒŸ å¯©æŸ»ã«æå‡ºã™ã‚‹æº–å‚™ãŒã§ãã¾ã—ãŸ"
  end

  desc "ğŸ“± ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆç”Ÿæˆ"
  lane :screenshots do
    capture_screenshots(
      scheme: "Obsidian Notes"
    )
  end

  desc "ğŸ” ã‚¢ãƒ—ãƒªæƒ…å ±ç¢ºèª"
  lane :info do
    puts "ğŸ“‹ Obsidian Notes ã‚¢ãƒ—ãƒªæƒ…å ±"
    puts "Bundle ID: #{ENV['DEVELOPER_APP_IDENTIFIER']}"
    puts "Apple ID: #{ENV['FASTLANE_APPLE_ID']}"
    puts "ğŸš€ æº–å‚™å®Œäº†ï¼"
  end

  # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
  error do |lane, exception|
    puts "âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: #{exception.message}"
  end
end