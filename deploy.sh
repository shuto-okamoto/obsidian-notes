#!/bin/bash

# AppFlowMVP Deployment Script
# App Store Connectã¨TestFlightã¸ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤

set -e

# --- è‰²ä»˜ã‘ç”¨ ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# --- é–¢æ•°å®šç¾© ---
print_header() {
    echo -e "${BLUE}================================${NC}"
    echo -e "${BLUE} AppFlowMVP Deployment${NC}"
    echo -e "${BLUE}================================${NC}"
    echo ""
}

print_step() {
    echo -e "${YELLOW}ðŸ“‹ $1${NC}"
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# --- è¨­å®šç¢ºèª ---
check_config() {
    print_step "è¨­å®šã‚’ç¢ºèªã—ã¦ã„ã¾ã™..."
    
    if [ ! -f "config/app_config.yml" ]; then
        print_error "è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"
        echo "å…ˆã« './setup_enhanced.sh' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"
        exit 1
    fi
    
    if [ ! -f ".env" ]; then
        print_error ".envãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"
        echo "å…ˆã« './setup_enhanced.sh' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"
        exit 1
    fi
    
    # .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
    export $(cat .env | grep -v '^#' | xargs)
    
    if [ -z "$FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD" ]; then
        print_error "App-Specific PasswordãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
        echo ".envãƒ•ã‚¡ã‚¤ãƒ«ã«FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORDã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚"
        exit 1
    fi
    
    print_success "è¨­å®šç¢ºèªå®Œäº†"
}

# --- Fastfileç¢ºèª ---
check_fastfile() {
    if [ ! -f "fastlane/Fastfile" ]; then
        print_step "Fastfileã‚’ä½œæˆã—ã¾ã™..."
        create_fastfile
    fi
}

# --- Fastfileä½œæˆ ---
create_fastfile() {
    # è¨­å®šå€¤ã‚’èª­ã¿è¾¼ã‚€
    BUNDLE_ID=$(yq eval '.app.bundle_id' config/app_config.yml)
    SCHEME=$(yq eval '.app.scheme' config/app_config.yml)
    WORKSPACE=$(yq eval '.app.workspace' config/app_config.yml)
    PROJECT=$(yq eval '.app.project' config/app_config.yml)
    
    cat > "fastlane/Fastfile" << EOF
# Fastfile - Auto-generated by AppFlowMVP

default_platform(:ios)

platform :ios do
  
  # Variables
  APP_IDENTIFIER = "$BUNDLE_ID"
  SCHEME = "$SCHEME"
  WORKSPACE = "$WORKSPACE"
  PROJECT = "$PROJECT"
  
  desc "Run tests"
  lane :test do
    run_tests(
      scheme: SCHEME,
      device: "iPhone 15 Pro"
    )
  end
  
  desc "Generate screenshots"
  lane :screenshots do
    capture_screenshots(
      scheme: SCHEME,
      devices: [
        "iPhone 15 Pro Max",
        "iPhone 15 Pro",
        "iPhone 13",
        "iPhone SE (3rd generation)",
        "iPad Pro (12.9-inch) (6th generation)"
      ],
      languages: ["ja-JP"],
      clear_previous_screenshots: true,
      override_status_bar: true
    )
  end
  
  desc "Upload to TestFlight"
  lane :beta do
    # è¨¼æ˜Žæ›¸å–å¾—
    match(type: "appstore")
    
    # IPAãƒ‘ã‚¹ã‚’å–å¾—
    ipa_path = "../build/ipa/*.ipa"
    
    # TestFlightã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    upload_to_testflight(
      ipa: ipa_path,
      skip_waiting_for_build_processing: false,
      changelog: "ãƒã‚°ä¿®æ­£ã¨æ©Ÿèƒ½æ”¹å–„"
    )
    
    # Slacké€šçŸ¥ï¼ˆè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
    if ENV["SLACK_URL"] && !ENV["SLACK_URL"].empty?
      slack(
        message: "ðŸš€ TestFlightã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸï¼",
        success: true
      )
    end
  end
  
  desc "Submit to App Store"
  lane :release do
    # è¨¼æ˜Žæ›¸å–å¾—
    match(type: "appstore")
    
    # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    deliver(
      submit_for_review: true,
      automatic_release: true,
      force: true,
      skip_binary_upload: false,
      metadata_path: "./fastlane/metadata",
      screenshots_path: "./fastlane/screenshots",
      precheck_include_in_app_purchases: false
    )
    
    # Slacké€šçŸ¥ï¼ˆè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
    if ENV["SLACK_URL"] && !ENV["SLACK_URL"].empty?
      slack(
        message: "ðŸŽ‰ App Storeã¸ã®ç”³è«‹ãŒå®Œäº†ã—ã¾ã—ãŸï¼",
        success: true
      )
    end
  end
  
  desc "Update metadata only"
  lane :update_metadata do
    deliver(
      submit_for_review: false,
      skip_binary_upload: true,
      skip_screenshots: false,
      force: true,
      metadata_path: "./fastlane/metadata",
      screenshots_path: "./fastlane/screenshots"
    )
  end
  
  # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
  error do |lane, exception|
    if ENV["SLACK_URL"] && !ENV["SLACK_URL"].empty?
      slack(
        message: "âŒ Lane '#{lane}' ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: #{exception.message}",
        success: false
      )
    end
  end
end
EOF
    
    print_success "Fastfileã‚’ä½œæˆã—ã¾ã—ãŸ"
}

# --- ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆç”Ÿæˆ ---
generate_screenshots() {
    print_step "ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ç”Ÿæˆã—ã¾ã™..."
    
    # UIãƒ†ã‚¹ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    if [ ! -d "*UITests" ]; then
        print_error "UIãƒ†ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"
        echo "ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆç”Ÿæˆã«ã¯UIãƒ†ã‚¹ãƒˆãŒå¿…è¦ã§ã™ã€‚"
        return 1
    fi
    
    bundle exec fastlane screenshots
    print_success "ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆç”Ÿæˆå®Œäº†"
}

# --- TestFlightãƒ‡ãƒ—ãƒ­ã‚¤ ---
deploy_beta() {
    print_step "TestFlightã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™..."
    
    # ãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
    if [ ! -f "build/ipa/"*.ipa ]; then
        print_error "IPAãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"
        echo "å…ˆã« './build_enhanced.sh' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"
        exit 1
    fi
    
    bundle exec fastlane beta
    print_success "TestFlightã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ï¼"
}

# --- App Storeãƒªãƒªãƒ¼ã‚¹ ---
deploy_release() {
    print_step "App Storeã«ãƒªãƒªãƒ¼ã‚¹ã—ã¾ã™..."
    
    # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
    if [ ! -d "fastlane/metadata" ]; then
        print_error "ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"
        echo "./setup_metadata.sh ã‚’å®Ÿè¡Œã—ã¦ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ã—ã¦ãã ã•ã„ã€‚"
        exit 1
    fi
    
    # ç¢ºèªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    echo -e "${YELLOW}âš ï¸  App Storeã¸ã®ãƒªãƒªãƒ¼ã‚¹ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚${NC}"
    read -p "ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚"
        exit 0
    fi
    
    bundle exec fastlane release
    print_success "App Storeã¸ã®ãƒªãƒªãƒ¼ã‚¹ç”³è«‹å®Œäº†ï¼"
}

# --- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ›´æ–° ---
update_metadata() {
    print_step "ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã™..."
    
    bundle exec fastlane update_metadata
    print_success "ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ›´æ–°å®Œäº†ï¼"
}

# --- ãƒ˜ãƒ«ãƒ—è¡¨ç¤º ---
show_help() {
    echo "Usage: $0 [command]"
    echo ""
    echo "Commands:"
    echo "  test          ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
    echo "  screenshots   ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ç”Ÿæˆ"
    echo "  beta          TestFlightã«ãƒ‡ãƒ—ãƒ­ã‚¤"
    echo "  release       App Storeã«ãƒªãƒªãƒ¼ã‚¹"
    echo "  metadata      ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ã¿æ›´æ–°"
    echo "  help          ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º"
    echo ""
    echo "Examples:"
    echo "  $0 beta       # TestFlightã«ãƒ‡ãƒ—ãƒ­ã‚¤"
    echo "  $0 release    # App Storeã«ãƒªãƒªãƒ¼ã‚¹"
}

# --- ãƒ¡ã‚¤ãƒ³å‡¦ç† ---
main() {
    print_header
    
    if [ $# -eq 0 ]; then
        show_help
        exit 1
    fi
    
    local command=$1
    
    case $command in
        "help"|"-h"|"--help")
            show_help
            exit 0
            ;;
        "test")
            check_config
            check_fastfile
            bundle exec fastlane test
            ;;
        "screenshots")
            check_config
            check_fastfile
            generate_screenshots
            ;;
        "beta")
            check_config
            check_fastfile
            deploy_beta
            ;;
        "release")
            check_config
            check_fastfile
            deploy_release
            ;;
        "metadata")
            check_config
            check_fastfile
            update_metadata
            ;;
        *)
            print_error "ä¸æ˜Žãªã‚³ãƒžãƒ³ãƒ‰: $command"
            show_help
            exit 1
            ;;
    esac
}

# å®Ÿè¡Œ
main "$@"